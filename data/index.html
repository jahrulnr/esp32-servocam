<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ESP-AI Web UI</title>
	<link href="assets/bootstrap.min.css" rel="stylesheet">
	<style>
		[data-bs-theme="dark"] .navbar-brand {
			color: #fff !important;
		}
		[data-bs-theme="dark"] .nav-link {
			color: rgba(255, 255, 255, 0.55) !important;
		}
		[data-bs-theme="dark"] .card {
			background-color: #343a40 !important;
			border-color: #495057 !important;
			color: #fff !important;
		}
		[data-bs-theme="dark"] .card-header {
			background-color: #495057 !important;
			border-color: #495057 !important;
			color: #fff !important;
		}
		[data-bs-theme="dark"] body {
			background-color: #212529 !important;
			color: #fff !important;
		}
		[data-bs-theme="dark"] #logArea {
			background-color: #343a40 !important;
			color: #fff !important;
			border-color: #495057 !important;
		}
		[data-bs-theme="dark"] #sidebar {
			background-color: #343a40 !important;
		}
		[data-bs-theme="dark"] #sidebar .nav-link {
			color: rgba(255, 255, 255, 0.75) !important;
		}
		[data-bs-theme="dark"] #sidebar .nav-link.active {
			color: #fff !important;
		}
		/* Mobile responsiveness */
		@media (max-width: 767.98px) {
			#sidebar {
				transform: translateX(-100%);
				transition: transform 0.3s ease;
			}
			#sidebar.show {
				transform: translateX(0);
			}
			.flex-fill {
				margin-left: 0 !important;
			}
			body.overlay-open {
				overflow: hidden;
			}
			body.overlay-open::after {
				content: '';
				position: fixed;
				top: 0;
			 	left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.5);
				z-index: 999;
			}
		}	
	</style>
</head>
<body class="py-md-5">
	<div class="d-flex">
		<!-- Sidebar -->
		<div id="sidebar" class="bg-primary text-white" style="width: 250px; min-height: 100vh; position: fixed; left: 0; top: 0; z-index: 1000;">
			<div class="p-3">
				<h5 class="fw-bold mb-4">ESP-AI</h5>
				<ul class="nav flex-column">
					<li class="nav-item mb-2">
						<a class="nav-link text-white active" id="nav-camera" href="#camera">
						Camera
						</a>
					</li>
					<li class="nav-item mb-2">
						<a class="nav-link text-white" id="nav-log" href="#log">
						Log
						</a>
					</li>
					<li class="nav-item mt-auto mb-2">
						<button class="btn btn-link nav-link text-white" id="themeToggle">
							‚òÄÔ∏è
						</button>
					</li>
				</ul>
			</div>
		</div>

		<!-- Main Content -->
		<div class="flex-fill px-2 px-lg-3" style="margin-left: 250px;">
			<!-- Mobile Header -->
			<nav class="navbar navbar-light d-md-none">
				<button class="btn btn-outline-secondary" type="button" id="sidebarToggle">
					‚ò∞
				</button>
				<span class="navbar-brand mb-0 h1">ESP-AI</span>
			</nav>
			<div class="row justify-content-center">
				<div class="col-lg-10">
					<!-- Camera View -->
					<div id="view-camera" class="view-content">
						<div class="card shadow-sm border-0">
							<div class="card-header bg-light p-2 p-lg-3">
								<h2 class="h5 mb-0 text-light">Camera View</h2>
							</div>
							<div class="card-body text-center p-2 p-lg-3">
								<img id="camera" src="" alt="Camera Feed" class="img-fluid rounded shadow-sm" style="max-width: 400px;">
								<div class="mt-3">
									<button id="fullscreenBtn" class="btn btn-outline-secondary me-2">
										Fullscreen
									</button>
								</div>
							</div>
						</div>
					</div>

					<!-- Log View -->
					<div id="view-log" class="view-content d-none">
						<div class="container-fluid mt-2 mt-lg-4">
							<div class="row justify-content-center">
								<div class="col-lg-10">
									<div class="card shadow-sm border-0">
										<div class="card-header bg-info text-white p-2 p-lg-3">
											<h2 class="h5 mb-0">System Log</h2>
										</div>
										<div class="card-body p-2 p-lg-3">
											<textarea id="logArea" class="form-control" rows="20" readonly style="font-family: monospace; font-size: 0.9em;"></textarea>
											<div class="mt-3">
												<button id="clearLogBtn" class="btn btn-outline-secondary">
													Clear Log
												</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

				</div>
			</div>
		</div>

		<script src="assets/jquery.min.js"></script>
		<script src="assets/bootstrap.bundle.js"></script>
		<script>
			$(document).ready(function() {
				// Detect host
				let hostname = globalThis.location.hostname;
				let isLocal = hostname === 'localhost' || hostname === '127.0.0.1' || /^192\.168\./.test(hostname) || /^10\.0\./.test(hostname) || /^172\.(1[6-9]|2\d|3[0-1])\./.test(hostname);
				let port = 81;
				let wsUrl;
				if (isLocal) {
					wsUrl = 'ws://' + hostname + ':' + port + '/ws';
				} else {
					wsUrl = '/ws';
				}

				// WebSocket connection (placeholder, backend later)
				let ws;
				function connectWS() {
					ws = new WebSocket(wsUrl);
					ws.onopen = function() {
						console.log('WebSocket connected to', wsUrl);
						$('#simulateBtn').hide(); // Hide simulate button when connected
						// Send ping periodically
						setInterval(function() {
							ws.send(JSON.stringify({type: 'ping'}));
						}, 5000);
					};
					ws.onmessage = function(event) {
						if (typeof event.data === 'string') {
							var msg = JSON.parse(event.data);
							if (msg.type === 'pong') {
								// Handle pong
							} else if (msg.type === 'log') {
								logMessage(`[${msg.level.toUpperCase()}] ${msg.message}`);
							}
						} else {
							// Assume binary camera data
							var reader = new FileReader();
							reader.onload = function() {
								$('#camera').attr('src', reader.result);
							};
							reader.readAsDataURL(event.data);
						}
					};
					ws.onclose = function() {
						console.log('WebSocket disconnected, reconnecting...');
						$('#simulateBtn').show(); // Show simulate button when disconnected
						setTimeout(connectWS, 1000);
					};
				}
				if (globalThis.location.protocol !== 'file:') {
					connectWS(); // Only connect when served over HTTP/HTTPS
				}

				function updateChart(chart, values) {
					dataCounter++;
					chart.data.forEach(function(series, index) {
						if (values[index] !== undefined) {
							series.dataPoints.push({ x: dataCounter, y: values[index] });
							if (series.dataPoints.length > maxPoints) {
								series.dataPoints.shift();
							}
						}
					});
					chart.render();
				}

				$('#fullscreenBtn').click(function() {
					const img = document.getElementById('camera');
					if (document.fullscreenElement) {
						document.exitFullscreen();
					} else {
						img.requestFullscreen().catch(err => {
							console.error('Error attempting to enable fullscreen:', err);
						});
					}
				});

				$('#sidebarToggle').click(function() {
					$('#sidebar').toggleClass('show');
					$('body').toggleClass('overlay-open');
				});

				// Close sidebar when clicking outside on mobile
				$(document).on('click', function(e) {
					if ($(globalThis).width() < 768 && $('body').hasClass('overlay-open') && !$(e.target).closest('#sidebar').length && !$(e.target).closest('#sidebarToggle').length) {
						$('#sidebar').removeClass('show');
						$('body').removeClass('overlay-open');
					}
				});

				$('#nav-camera').click(function(e) {
					e.preventDefault();
					$('.view-content').addClass('d-none');
					$('#view-camera').removeClass('d-none');
					$('#sidebar .nav-link').removeClass('active');
					$(this).addClass('active');
				});
				$('#nav-log').click(function(e) {
					e.preventDefault();
					$('.view-content').addClass('d-none');
					$('#view-log').removeClass('d-none');
					$('#sidebar .nav-link').removeClass('active');
					$(this).addClass('active');
				});

				$('#themeToggle').click(function() {
					const html = document.documentElement;
					const body = document.body;
					const currentTheme = html.dataset('data-bs-theme');
					const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
					html.dataset('data-bs-theme', newTheme);
					body.dataset('data-bs-theme', newTheme);
					$(this).text(newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô');
				});

				// Log function
				function logMessage(message) {
					const timestamp = new Date().toLocaleTimeString();
					$('#logArea').append(`[${timestamp}] ${message}\n`);
					// Limit to 1000 lines
					let lines = $('#logArea').val().split('\n');
					if (lines.length > 1000) {
						lines = lines.slice(-1000);
						$('#logArea').val(lines.join('\n'));
					}
					$('#logArea').scrollTop($('#logArea')[0].scrollHeight);
				}

				$('#clearLogBtn').click(function() {
					$('#logArea').val('');
				});
			});
		</script>
	</div>
</body>
</html>